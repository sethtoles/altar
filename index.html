<html>
    <head>
        <meta charset="utf-8"></meta>
        <title>Altar</title>
    </head>
    <body style="margin: 0; padding: 0;">
        <canvas id="gameLayer" style="width: 100%; height: 100%;"></canvas>
    </body>
    <script type="text/javascript" src="./constants.js"></script>
    <script type="text/javascript" src="./utils.js"></script>
    <script type="text/javascript" src="./tiles.js"></script>
    <script type="text/javascript" src="./spacialHash.js"></script>
    <script type="text/javascript" src="./eventHandlers.js"></script>
    <script type="text/javascript" src="./renderable.js"></script>
    <script type="text/javascript" src="./gameObject.js"></script>
    <script type="text/javascript" src="./targeting.js"></script>
    <script type="text/javascript" src="./map.js"></script>
    <script type="text/javascript" src="./camera.js"></script>
    <script type="text/javascript" src="./character.js"></script>
    <script type="text/javascript" src="./player.js"></script>
    <script>
        // Stored Elements
        const elements = getElements();

        // Canvas State
        const ctx = getContext();

        // Game State
        const scene = sceneFactory();
        this.scene = scene;
        const held = {};
        let elapsed = 0;

        // Environment Setup
        addListeners();
        handleResize();

        // Game Setup

        // Game Start
        scene.camera.zoomChanged()
        gameLoop();

        // -- FUNCTION DEFINITIONS -- //

        function getElements() {
            return {
                canvas: document.getElementById('gameLayer'),
            };
        }

        function getContext() {
            return elements.canvas.getContext('2d');
        }

        function sceneFactory() {
            const background = mapFactory(WORLD_MAP);
            const player = playerFactory({
                sprintSpeed: 5,
            });
            const targets = [];
            const characters = [];
            const colliders = spacialHashFactory();


            const testingObj = gameObjectFactory({
                x: 300,
                y: 275,
                tileSet: [
                    {
                        tile: TILES.character,
                    },
                ],
            });
            colliders.addChild(testingObj);
            characters.push(testingObj);


            characters.push(player);
            colliders.addChild(player);

            return {
                layers: [
                    background,
                    targets,
                    characters,
                ],
                targets,
                characters,
                player,
                colliders,
                camera: cameraFactory({ following: player }),
                paused: false,
            };
        }

        function gameLoop(timer) {
            if (scene.paused) {
                return;
            }

            const frameTime = timer - elapsed;
            const extraTime = Math.min(0, 25 - frameTime); // Limit to 40fps
            elapsed = timer;

            clearScreen();

            scene.camera.follow();

            scene.layers.forEach((layer) => {
                layer.forEach((object) => {
                    // TODO: Move to worker
                    if (object.processFrame) {
                        object.processFrame();
                    }

                    if (object.render) {
                        object.render(scene.camera);
                    }
                });
            });

            setTimeout(() => {
                window.requestAnimationFrame(gameLoop);
            }, extraTime);
        }

        function togglePause() {
            scene.paused = !scene.paused;
            utils.clearHeld();

            if (scene.paused) {
                clearScreen();
                ctx.fillStyle = COLOR.BLACK;
                ctx.font = FONT.PRIMARY;
                ctx.textAlign = 'center';
                ctx.fillText(
                    'PAUSED',
                    elements.canvas.width / 2,
                    elements.canvas.height / 2
                );
            }
            else {
                gameLoop();
            }
        }

        function clearScreen() {
            ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
        }
    </script>
</html>
