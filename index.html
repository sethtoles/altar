<html>
    <head>
        <title>Altar</title>
    </head>
    <body style="margin: 0; padding: 0;">
        <canvas id="gameLayer" style="width: 100%; height: 100%;"></canvas>
    </body>
    <script type="text/javascript" src="./constants.js"></script>
    <script type="text/javascript" src="./utils.js"></script>
    <script type="text/javascript" src="./tiles.js"></script>
    <script type="text/javascript" src="./spacialHash.js"></script>
    <script type="text/javascript" src="./eventHandlers.js"></script>
    <script type="text/javascript" src="./gameObject.js"></script>
    <script type="text/javascript" src="./targeting.js"></script>
    <script type="text/javascript" src="./map.js"></script>
    <script type="text/javascript" src="./camera.js"></script>
    <script type="text/javascript" src="./character.js"></script>
    <script type="text/javascript" src="./player.js"></script>
    <script>
        // Stored Elements
        const elements = getElements();

        // Canvas State
        const ctx = getContext();

        // Game State
        const scene = sceneFactory();
        this.scene = scene;
        const held = {};

        // Environment Setup
        addListeners();
        handleResize();

        // Game Setup

        // Game Start
        scene.camera.zoomChanged()
        gameLoop();

        // -- FUNCTION DEFINITIONS -- //

        function getElements() {
            return{
                canvas: document.getElementById('gameLayer'),
            };
        }

        function getContext() {
            return elements.canvas.getContext('2d');
        }

        function sceneFactory() {
            const background = mapFactory(WORLD_MAP);
            const player = playerFactory({
                // height: 2,
                sprintSpeed: 5,
            });
            const targets = [];
            const characters = [];
            const colliders = spacialHashFactory();


            const testingObj = gameObjectFactory({
                x: 300,
                y: 275,
                // height: 2,
                tile: TILES.character,
                canCollide: true,
            });
            colliders.addChild(testingObj);
            characters.push(testingObj);


            characters.push(player);
            colliders.addChild(player);

            return {
                layers: [
                    background,
                    targets,
                    characters,
                ],
                targets,
                characters,
                player,
                colliders,
                camera: cameraFactory(),
                paused: false,
            };
        }

        function gameLoop(timer) {
            if (scene.paused) {
                return;
            }

            clearScreen();

            scene.camera.follow(scene.player, true);

            scene.layers.forEach((layer) => {
                layer.forEach((object) => {
                    if (object.processFrame) {
                        object.processFrame();
                    }

                    object.render(scene.camera);
                });
            });

            window.requestAnimationFrame(gameLoop);
        }

        function togglePause() {
            scene.paused = !scene.paused;

            if (scene.paused) {
                clearScreen(COLOR.BLACK);

                ctx.fillStyle = COLOR.WHITE;
                ctx.font = FONT.PRIMARY;
                ctx.textAlign = 'center';
                ctx.fillText(
                    'PAUSED',
                    elements.canvas.width / 2,
                    elements.canvas.height / 2
                );
            }
            else {
                gameLoop();
            }
        }

        function clearScreen(color = COLOR.WHITE) {
            const { fillStyle } = ctx;

            ctx.fillStyle = color;
            ctx.fillRect(
                0,
                0,
                elements.canvas.width,
                elements.canvas.height
            );

            ctx.fillStyle = fillStyle;
        }
    </script>
</html>
