<html>
    <head>
        <title>Altar</title>
    </head>
    <body style="margin: 0; padding: 0;">
        <canvas id="gameLayer" style="width: 100%; height: 100%;"></canvas>
    </body>
    <script type="text/javascript" src="./constants.js"></script>
    <script type="text/javascript" src="./tiles.js"></script>
    <script type="text/javascript" src="./eventHandlers.js"></script>
    <script type="text/javascript" src="./gameObject.js"></script>
    <script type="text/javascript" src="./targeting.js"></script>
    <script type="text/javascript" src="./map.js"></script>
    <script type="text/javascript" src="./camera.js"></script>
    <script type="text/javascript" src="./character.js"></script>
    <script type="text/javascript" src="./player.js"></script>
    <script>
        // Stored Elements
        const el = {};

        // Canvas State
        let ctx;

        // Game State
        const player = playerFactory();
        const scene = buildScene();
        const held = {};
        let paused = false;

        // Environment Setup
        addListeners();
        getElements();
        getContexts();
        handleResize();

        // Game Setup

        // Game Start
        scene.camera.zoomChanged()
        scene.camera.follow(player);
        gameLoop();

        // -- FUNCTION DEFINITIONS -- //

        function getElements() {
            el.canvas = document.getElementById('gameLayer');
        }

        function getContexts() {
            ctx = el.canvas.getContext('2d');
        }

        function buildScene() {
            const background = mapFactory(WORLD_MAP);
            const targets = [];
            const characters = [];

            characters.push(player);

            return {
                layers: [
                    background,
                    targets,
                    characters,
                ],
                targets,
                characters,
                camera: cameraFactory(),
            };
        }

        function gameLoop(timer) {
            if (paused) {
                return;
            }

            clearScreen();

            scene.camera.follow(player, true);

            scene.layers.forEach((layer) => {
                layer.forEach((object) => {
                    if (object.processFrame) {
                        object.processFrame();
                    }

                    object.render(scene.camera);
                });
            });

            window.requestAnimationFrame(gameLoop);
        }

        function togglePause() {
            paused = !paused;

            if (paused) {
                clearScreen(COLOR.BLACK);

                ctx.fillStyle = COLOR.WHITE;
                ctx.font = FONT.PRIMARY;
                ctx.textAlign = 'center';
                ctx.fillText(
                    'PAUSED',
                    el.canvas.width / 2,
                    el.canvas.height / 2
                );
            } else {
                gameLoop();
            }
        }

        function clearScreen(color = COLOR.WHITE) {
            const { fillStyle } = ctx;

            ctx.fillStyle = color;
            ctx.fillRect(
                0,
                0,
                el.canvas.width,
                el.canvas.height
            );

            ctx.fillStyle = fillStyle;
        }
    </script>
</html>
